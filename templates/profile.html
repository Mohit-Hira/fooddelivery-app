{% extends "base.html" %}
{% block title %}Profile - Yummies{% endblock %}

{% block content %}
<div class="profile-container">
  <h2>üë§ Your Profile</h2>

  <div class="profile-card">
    <img id="profilePic" src="{{ user.photo_url | default('/static/images/avatar.png') }}" alt="Profile Picture" class="profile-pic">
    
    <form id="profileForm" enctype="multipart/form-data">
      <input type="text" name="name" value="{{ user.name | default('Guest User') }}" placeholder="Your Name" class="name-input" id="nameInput">
      <input type="file" name="file" accept="image/*" class="file-input" id="fileInput">
      <button type="submit" class="update-btn">Update Profile</button>
    </form>

    <p>Email: {{ user.email | default('Not provided') }}</p>
    <p>Joined: {{ user.joined_date | default('N/A') }}</p>

    <!-- Logout button styled like login button -->
    <button class="logout-btn" onclick="window.location.href='/logout'">Logout</button>
  </div>
</div>

<!-- Bottom navigation -->
<nav class="bottom-nav">
  <button class="nav-btn" id="home-btn">üè†<span>Home</span></button>
  <button class="nav-btn" id="menu-btn">üçî<span>Menu</span></button>
  <button class="nav-btn" id="chat-btn">üí¨<span>Chat</span></button>
  <button class="nav-btn" id="fav-btn">‚ù§Ô∏è<span>Favorites</span></button>
  <button class="nav-btn active" id="profile-btn">üë§<span>Profile</span></button>
</nav>

<style>
.profile-container { max-width:500px; margin:50px auto; font-family:'Poppins', sans-serif; padding-bottom:70px; }
.profile-card { background:#fff; border-radius:15px; box-shadow:0 3px 8px rgba(0,0,0,0.1); padding:30px; text-align:center; }
.profile-pic { width:120px; height:120px; border-radius:50%; object-fit:cover; margin-bottom:15px; }
.name-input, .file-input { width:100%; padding:8px; margin:8px 0; border-radius:5px; border:1px solid #ccc; }
.update-btn { width:100%; padding:10px; background:#E46A1C; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:600; margin-bottom:10px; }

/* Logout button styled like login button */
.logout-btn {
    width:100%;
    padding:10px;
    background:#00c853;
    color:#fff;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    margin-top:5px;
    transition:0.2s;
}
.logout-btn:hover { background:#00b34a; }

.bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#fff; box-shadow:0 -2px 8px rgba(0,0,0,0.1); display:flex; justify-content:space-around; padding:8px 0; z-index:1000; }
.nav-btn { background:none; border:none; color:#888; font-size:1.2em; display:flex; flex-direction:column; align-items:center; font-weight:500; cursor:pointer; transition:0.2s; }
.nav-btn span { font-size:0.75em; }
.nav-btn.active, .nav-btn:hover { color:#E46A1C; }
</style>

<script>
document.getElementById("home-btn").addEventListener("click", () => location.href="/home");
document.getElementById("menu-btn").addEventListener("click", () => location.href="/menu");
document.getElementById("chat-btn").addEventListener("click", () => location.href="/chat");
document.getElementById("fav-btn").addEventListener("click", () => location.href="/favorites");
document.getElementById("profile-btn").addEventListener("click", () => location.href="/profile");

// Live Image Preview
const fileInput = document.getElementById("fileInput");
const profilePic = document.getElementById("profilePic");

fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            profilePic.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }
});

// Dynamic Profile Update
document.getElementById("profileForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const res = await fetch("/api/profile/update", {
            method: "POST",
            body: formData
        });
        const data = await res.json();

        if (data.ok) {
            if (data.user.name) document.getElementById("nameInput").value = data.user.name;
            if (data.user.photo_url) profilePic.src = data.user.photo_url;
            if (data.user.joined_date) document.querySelector('p:nth-of-type(2)').textContent = `Joined: ${data.user.joined_date}`;

            alert("Profile updated successfully!");
        } else {
            alert("Failed to update profile.");
        }
    } catch (err) {
        console.error(err);
        alert("Error updating profile.");
    }
});
</script>
{% endblock %}
